
import locale
import os
import sys
from typing import Dict, Any

from add_dub.config.effective import effective_values

# Dictionnaires de traduction
TRANSLATIONS = {
    "fr": {
        "cli_no_video": "Aucune vidéo détectée. Place des fichiers dans ./input ou indique --input.",
        "cli_batch_start": "[BATCH] {path}",
        "cli_sub_choice": "  -> subtitles choice: {choice}",
        "cli_audio_index": "  -> audio_index (ffprobe global): {index}",
        "cli_tts_engine": "  -> tts_engine: {engine}",
        "cli_voice": "  -> voice: {voice}",
        "cli_codec": "  -> codec: {codec} @ {bitrate} kb/s",
        "cli_mix": "  -> bg_mix={bg_mix}, tts_mix={tts_mix}, ducking_db={ducking_db}",
        "cli_rates": "  -> min_rate_tts={min}, max_rate_tts={max}",
        "cli_offsets": "  -> offset_ms={offset}, offset_video_ms={offset_video}",
        "cli_error": "[ERREUR] {msg}",
        "cli_done": "Terminé.",
        "cli_dirs": "[dirs] \ninput  = {input} \noutput = {output} \ntmp    = {tmp}",
        "cli_no_eligible": "Aucun fichier éligible trouvé dans {path}",
        "cli_no_eligible_short": "Aucun fichier vidéo exploitable trouvé.",
        "cli_help_formats": "Extensions acceptées : .mkv, .mp4 (non récursif).",
        "cli_help_input": "Placez les vidéos directement dans le dossier d'entrée.",
        "cli_menu_title": "Que voulez-vous faire ?",
        "cli_menu_change_input": "1) Changer le dossier d'entrée",
        "cli_menu_help": "2) Afficher l'aide (rappel des formats attendus)",
        "cli_menu_rescan": "3) Relancer le test (re-scanner)",
        "cli_menu_quit": "4) Quitter",
        "cli_input_choice": "Choix [3] : ",
        "cli_new_input": "Nouveau dossier d'entrée : ",
        "cli_input_changed": "Dossier d'entrée changé vers: {path}",
        "cli_help_details": "\nAIDE :\n- Placez des vidéos .mkv / .mp4 dans le dossier d'entrée.\n- Les sous-titres .srt sont facultatifs (même nom que la vidéo).\n- Les sous-dossiers ne sont pas scannés (non récursif).\n- Évitez les fichiers de taille nulle ou verrouillés.",
        "cli_press_enter": "\nAppuyez sur Entrée pour re-scanner...",
        "cli_invalid_choice": "Choix invalide, on relance le scan.",
        "cli_no_selection": "Aucun fichier sélectionné.",
        "cli_ask_another": "Voulez-vous générer une autre vidéo ? (o/n) : ",
        "cli_files_list": "\nFichiers éligibles (input/):",
        "cli_select_files": "Entrez les numéros à traiter (espaces, Entrée=tout, q=annuler) : ",
        "cli_selection_cancelled": "Aucun fichier sélectionné.",
        "cli_invalid_selection": "Saisie invalide. Exemple : 1 3 5 (dans l’intervalle 1..{max}).",
        "cli_audio_tracks": "\nPistes audio disponibles :",
        "cli_track_info": "    {idx} : ffmpeg index {ff_idx}, langue={lang}, titre={title}",
        "cli_choose_track": "Numéro de la piste audio à utiliser (Entrée=0, q=annuler) : ",
        "cli_track_cancelled": "Sélection de piste annulée.",
        "cli_invalid_track": "Saisie invalide. Choisis un nombre entre 0 et {max}, ou q pour annuler.",
        "cli_no_subs": "Aucune source de sous-titres disponible.",
        "cli_subs_sources": "\nSources de sous-titres :",
        "cli_choose_sub": "Choisir la source ST (0..{max}) [0]: ",
        "cli_lang_avail": "\nLangues TTS disponibles :",
        "cli_choose_lang": "Saisir le numéro de la langue [1] : ",
        "cli_variants_avail": "\nVariantes disponibles pour {lang} :",
        "cli_choose_variant": "Saisir le numéro de la variante [1] : ",
        "cli_voices_avail": "\nVoix disponibles :",
        "cli_choose_voice": "Saisir le numéro de la voix (ou Entrée pour annuler) : ",
        "cli_engine_choice": "\nChoix du moteur TTS :",
        "cli_engine_1": "    1) OneCore (local)",
        "cli_engine_2": "    2) Edge TTS (cloud)",
        "cli_engine_3": "    3) gTTS (cloud, non officiel)",
        "cli_choose_engine": "Saisir le numéro du moteur [1] : ",
        "cli_no_sub_chosen": "Aucune source de sous-titres choisie.",
        "cli_no_voice": "[ERREUR] Aucune voix TTS valide disponible (même en fallback OneCore).",
        "pipeline_process": "{name}",
        "pipeline_no_srt": "Impossible d'obtenir un SRT pour {name}.",
        "pipeline_extract_audio": "\nExtraction de l'audio d'origine (WAV PCM)...",
        "pipeline_no_subs_usable": "Aucun sous-titre exploitable.",
        "pipeline_gen_tts": "\nGénération TTS (WAV)...",
        "pipeline_ducking": "\nDucking de l'audio original pendant les dialogues...",
        "pipeline_mux": "\nMixage/Encodage/Mux final...",
        "pipeline_test_header": "\n=== TEST AVANT NETTOYAGE ===",
        "pipeline_test_file": "Fichier généré : {path}",
        "pipeline_test_check": "Ouvrez la vidéo et vérifiez les niveaux (bg / tts).",
        "pipeline_test_ask": "Souhaitez-vous ajuster les niveaux et refaire le mux ? (o/n) : ",
        "pipeline_test_ask_bg": "Nouveau niveau BG (volume background, ex. 1.0, 2.5)",
        "pipeline_test_ask_tts": "Nouveau niveau TTS (volume voix, ex. 1.0, 3.0)",
        "pipeline_test_remux": "\nRe-mux avec nouveaux niveaux...",
        "pipeline_test_done": "Re-mux terminé → {path}",
        "pipeline_test_continue": "Réouvrez la vidéo pour vérifier. CTRL+C pour quitter, sinon poursuivez.",
        "pipeline_test_deleted": "[TEST] Fichier supprimé : {path}",
        "pipeline_test_del_err": "[TEST] Impossible de supprimer le fichier de test ({path}) : {err}",
        "opt_input_dir": "Dossier d'entrée (input_dir)",
        "opt_output_dir": "Dossier de sortie (output_dir)",
        "opt_tmp_dir": "Dossier temporaire (tmp_dir)",
        "opt_orig_lang": "Langue originale",
        "opt_ducking": "Réduction (ducking) en dB",
        "opt_offset": "Décalage ST/TTS (ms, négatif = plus tôt)",
        "opt_offset_video": "Décalage vidéo (ms, négatif = plus tôt)",
        "opt_bg_mix": "Niveau BG (1.0 = inchangé)",
        "opt_tts_mix": "Niveau TTS (1.0 = inchangé)",
        "opt_min_rate": "Vitesse TTS minimal (1.0 = inchangé)",
        "opt_max_rate": "Vitesse TTS maximal (1.8 = inchangé)",
        "opt_codec": "Codec audio",
        "opt_bitrate": "Bitrate",
        "ui_invalid_value": "Valeur invalide, on garde le défaut.",
        "tts_progress": "\rTTS: {pct}% [{done}/{total}]",
        "tts_warn_freeze": "\n[WARN] Aucune avancée TTS. Relance synchrone des segments restants...",
        "sub_mkvtoolnix_required": "MKVToolNix requis pour identifier les pistes (mkvmerge).",
        "sub_no_tracks": "Aucune piste de sous-titres intégrée.",
        "sub_extract_text_success": "SRT extrait (texte) -> {path}",
        "sub_extract_text_failed": "Échec extraction SRT (texte).",
        "sub_ffmpeg_error": "Erreur ffmpeg extraction ST texte: {err}",
        "sub_mkvextract_not_found": "mkvextract introuvable.",
        "sub_ocr_success": "SRT OCR ({method}) -> {path}",
        "sub_no_ocr": "Aucun OCR disponible.",
        "sub_auto_extract_failed": "[AUTO] Échec extraction SRT depuis la piste MKV sélectionnée pour {video}.",
        "sub_auto_not_found": "[AUTO] SRT introuvable pour {video}.",
    },
    "en": {
        "cli_no_video": "No video detected. Place files in ./input or use --input.",
        "cli_batch_start": "[BATCH] {path}",
        "cli_sub_choice": "  -> subtitles choice: {choice}",
        "cli_audio_index": "  -> audio_index (ffprobe global): {index}",
        "cli_tts_engine": "  -> tts_engine: {engine}",
        "cli_voice": "  -> voice: {voice}",
        "cli_codec": "  -> codec: {codec} @ {bitrate} kb/s",
        "cli_mix": "  -> bg_mix={bg_mix}, tts_mix={tts_mix}, ducking_db={ducking_db}",
        "cli_rates": "  -> min_rate_tts={min}, max_rate_tts={max}",
        "cli_offsets": "  -> offset_ms={offset}, offset_video_ms={offset_video}",
        "cli_error": "[ERROR] {msg}",
        "cli_done": "Done.",
        "cli_dirs": "[dirs] \ninput  = {input} \noutput = {output} \ntmp    = {tmp}",
        "cli_no_eligible": "No eligible file found in {path}",
        "cli_no_eligible_short": "No usable video file found.",
        "cli_help_formats": "Accepted extensions: .mkv, .mp4 (non-recursive).",
        "cli_help_input": "Place videos directly in the input folder.",
        "cli_menu_title": "What do you want to do?",
        "cli_menu_change_input": "1) Change input folder",
        "cli_menu_help": "2) Show help (format reminder)",
        "cli_menu_rescan": "3) Rerun test (rescan)",
        "cli_menu_quit": "4) Quit",
        "cli_input_choice": "Choice [3]: ",
        "cli_new_input": "New input folder: ",
        "cli_input_changed": "Input folder changed to: {path}",
        "cli_help_details": "\nHELP:\n- Place .mkv / .mp4 videos in the input folder.\n- .srt subtitles are optional (same name as video).\n- Subfolders are not scanned (non-recursive).\n- Avoid zero-byte or locked files.",
        "cli_press_enter": "\nPress Enter to rescan...",
        "cli_invalid_choice": "Invalid choice, rescanning.",
        "cli_no_selection": "No file selected.",
        "cli_ask_another": "Do you want to generate another video? (y/n): ",
        "cli_files_list": "\nEligible files (input/):",
        "cli_select_files": "Enter numbers to process (spaces, Enter=all, q=cancel): ",
        "cli_selection_cancelled": "No file selected.",
        "cli_invalid_selection": "Invalid input. Example: 1 3 5 (in range 1..{max}).",
        "cli_audio_tracks": "\nAvailable audio tracks:",
        "cli_track_info": "    {idx} : ffmpeg index {ff_idx}, language={lang}, title={title}",
        "cli_choose_track": "Audio track number to use (Enter=0, q=cancel): ",
        "cli_track_cancelled": "Track selection cancelled.",
        "cli_invalid_track": "Invalid input. Choose a number between 0 and {max}, or q to cancel.",
        "cli_no_subs": "No subtitle source available.",
        "cli_subs_sources": "\nSubtitle sources:",
        "cli_choose_sub": "Choose subtitle source (0..{max}) [0]: ",
        "cli_lang_avail": "\nAvailable TTS languages:",
        "cli_choose_lang": "Enter language number [1]: ",
        "cli_variants_avail": "\nVariants available for {lang}:",
        "cli_choose_variant": "Enter variant number [1]: ",
        "cli_voices_avail": "\nAvailable voices:",
        "cli_choose_voice": "Enter voice number (or Enter to cancel): ",
        "cli_engine_choice": "\nTTS Engine Choice:",
        "cli_engine_1": "    1) OneCore (local)",
        "cli_engine_2": "    2) Edge TTS (cloud)",
        "cli_engine_3": "    3) gTTS (cloud, unofficial)",
        "cli_choose_engine": "Enter engine number [1]: ",
        "cli_no_sub_chosen": "No subtitle source chosen.",
        "cli_no_voice": "[ERROR] No valid TTS voice available (even in OneCore fallback).",
        "pipeline_process": "{name}",
        "pipeline_no_srt": "Cannot get SRT for {name}.",
        "pipeline_extract_audio": "\nExtracting original audio (PCM WAV)...",
        "pipeline_no_subs_usable": "No usable subtitles.",
        "pipeline_gen_tts": "\nGenerating TTS (WAV)...",
        "pipeline_ducking": "\nDucking original audio during dialogue...",
        "pipeline_mux": "\nMixing/Encoding/Final Mux...",
        "pipeline_test_header": "\n=== TEST BEFORE CLEANUP ===",
        "pipeline_test_file": "Generated file: {path}",
        "pipeline_test_check": "Open the video and check levels (bg / tts).",
        "pipeline_test_ask": "Do you want to adjust levels and remux? (y/n): ",
        "pipeline_test_ask_bg": "New BG level (background volume, e.g. 1.0, 2.5)",
        "pipeline_test_ask_tts": "New TTS level (voice volume, e.g. 1.0, 3.0)",
        "pipeline_test_remux": "\nRemuxing with new levels...",
        "pipeline_test_done": "Remux done -> {path}",
        "pipeline_test_continue": "Reopen video to verify. CTRL+C to quit, otherwise continue.",
        "pipeline_test_deleted": "[TEST] File deleted: {path}",
        "pipeline_test_del_err": "[TEST] Cannot delete test file ({path}): {err}",
        "opt_input_dir": "Input folder (input_dir)",
        "opt_output_dir": "Output folder (output_dir)",
        "opt_tmp_dir": "Temporary folder (tmp_dir)",
        "opt_orig_lang": "Original language",
        "opt_ducking": "Reduction (ducking) in dB",
        "opt_offset": "Subtitle/TTS offset (ms, negative = earlier)",
        "opt_offset_video": "Video offset (ms, negative = earlier)",
        "opt_bg_mix": "BG Level (1.0 = unchanged)",
        "opt_tts_mix": "TTS Level (1.0 = unchanged)",
        "opt_min_rate": "Min TTS speed (1.0 = unchanged)",
        "opt_max_rate": "Max TTS speed (1.8 = unchanged)",
        "opt_codec": "Audio codec",
        "opt_bitrate": "Bitrate",
        "ui_invalid_value": "Invalid value, keeping default.",
        "tts_progress": "\rTTS: {pct}% [{done}/{total}]",
        "tts_warn_freeze": "\n[WARN] No TTS progress. Synchronous relaunch of remaining segments...",
        "sub_mkvtoolnix_required": "MKVToolNix required to identify tracks (mkvmerge).",
        "sub_no_tracks": "No embedded subtitle tracks.",
        "sub_extract_text_success": "SRT extracted (text) -> {path}",
        "sub_extract_text_failed": "SRT extraction failed (text).",
        "sub_ffmpeg_error": "ffmpeg error extracting text subs: {err}",
        "sub_mkvextract_not_found": "mkvextract not found.",
        "sub_ocr_success": "SRT OCR ({method}) -> {path}",
        "sub_no_ocr": "No OCR available.",
        "sub_auto_extract_failed": "[AUTO] Failed to extract SRT from selected MKV track for {video}.",
        "sub_auto_not_found": "[AUTO] SRT not found for {video}.",
    },
    "es": {
        "cli_no_video": "No se detectó ningún video. Coloque archivos en ./input o use --input.",
        "cli_batch_start": "[LOTE] {path}",
        "cli_sub_choice": "  -> elección de subtítulos: {choice}",
        "cli_audio_index": "  -> índice de audio (ffprobe global): {index}",
        "cli_tts_engine": "  -> motor tts: {engine}",
        "cli_voice": "  -> voz: {voice}",
        "cli_codec": "  -> códec: {codec} @ {bitrate} kb/s",
        "cli_mix": "  -> mezcla_bg={bg_mix}, mezcla_tts={tts_mix}, ducking_db={ducking_db}",
        "cli_rates": "  -> tasa_min_tts={min}, tasa_max_tts={max}",
        "cli_offsets": "  -> desplazamiento_ms={offset}, desplazamiento_video_ms={offset_video}",
        "cli_error": "[ERROR] {msg}",
        "cli_done": "Hecho.",
        "cli_dirs": "[directorios] \nentrada = {input} \nsalida  = {output} \ntmp     = {tmp}",
        "cli_no_eligible": "No se encontró ningún archivo elegible en {path}",
        "cli_no_eligible_short": "No se encontró ningún archivo de video utilizable.",
        "cli_help_formats": "Extensiones aceptadas: .mkv, .mp4 (no recursivo).",
        "cli_help_input": "Coloque los videos directamente en la carpeta de entrada.",
        "cli_menu_title": "¿Qué desea hacer?",
        "cli_menu_change_input": "1) Cambiar carpeta de entrada",
        "cli_menu_help": "2) Mostrar ayuda (recordatorio de formatos)",
        "cli_menu_rescan": "3) Volver a probar (volver a escanear)",
        "cli_menu_quit": "4) Salir",
        "cli_input_choice": "Elección [3]: ",
        "cli_new_input": "Nueva carpeta de entrada: ",
        "cli_input_changed": "Carpeta de entrada cambiada a: {path}",
        "cli_help_details": "\nAYUDA:\n- Coloque videos .mkv / .mp4 en la carpeta de entrada.\n- Los subtítulos .srt son opcionales (mismo nombre que el video).\n- No se escanean subcarpetas (no recursivo).\n- Evite archivos de tamaño cero o bloqueados.",
        "cli_press_enter": "\nPresione Entrar para volver a escanear...",
        "cli_invalid_choice": "Elección no válida, volviendo a escanear.",
        "cli_no_selection": "Ningún archivo seleccionado.",
        "cli_ask_another": "¿Desea generar otro video? (s/n): ",
        "cli_files_list": "\nArchivos elegibles (input/):",
        "cli_select_files": "Ingrese los números a procesar (espacios, Entrar=todos, q=cancelar): ",
        "cli_selection_cancelled": "Ningún archivo seleccionado.",
        "cli_invalid_selection": "Entrada no válida. Ejemplo: 1 3 5 (en el rango 1..{max}).",
        "cli_audio_tracks": "\nPistas de audio disponibles:",
        "cli_track_info": "    {idx} : índice ffmpeg {ff_idx}, idioma={lang}, título={title}",
        "cli_choose_track": "Número de pista de audio a usar (Entrar=0, q=cancelar): ",
        "cli_track_cancelled": "Selección de pista cancelada.",
        "cli_invalid_track": "Entrada no válida. Elija un número entre 0 y {max}, o q para cancelar.",
        "cli_no_subs": "No hay fuente de subtítulos disponible.",
        "cli_subs_sources": "\nFuentes de subtítulos:",
        "cli_choose_sub": "Elegir fuente de subtítulos (0..{max}) [0]: ",
        "cli_lang_avail": "\nIdiomas TTS disponibles:",
        "cli_choose_lang": "Ingrese el número de idioma [1]: ",
        "cli_variants_avail": "\nVariantes disponibles para {lang}:",
        "cli_choose_variant": "Ingrese el número de variante [1]: ",
        "cli_voices_avail": "\nVoces disponibles:",
        "cli_choose_voice": "Ingrese el número de voz (o Entrar para cancelar): ",
        "cli_engine_choice": "\nElección del motor TTS:",
        "cli_engine_1": "    1) OneCore (local)",
        "cli_engine_2": "    2) Edge TTS (nube)",
        "cli_engine_3": "    3) gTTS (nube, no oficial)",
        "cli_choose_engine": "Ingrese el número de motor [1]: ",
        "cli_no_sub_chosen": "Ninguna fuente de subtítulos elegida.",
        "cli_no_voice": "[ERROR] No hay voz TTS válida disponible (incluso en OneCore fallback).",
        "pipeline_process": "{name}",
        "pipeline_no_srt": "No se puede obtener SRT para {name}.",
        "pipeline_extract_audio": "\nExtrayendo audio original (PCM WAV)...",
        "pipeline_no_subs_usable": "No hay subtítulos utilizables.",
        "pipeline_gen_tts": "\nGenerando TTS (WAV)...",
        "pipeline_ducking": "\nAtenuando audio original durante el diálogo...",
        "pipeline_mux": "\nMezcla/Codificación/Mux final...",
        "pipeline_test_header": "\n=== PRUEBA ANTES DE LIMPIEZA ===",
        "pipeline_test_file": "Archivo generado: {path}",
        "pipeline_test_check": "Abra el video y verifique los niveles (bg / tts).",
        "pipeline_test_ask": "¿Desea ajustar los niveles y volver a muxear? (s/n): ",
        "pipeline_test_ask_bg": "Nuevo nivel BG (volumen de fondo, ej. 1.0, 2.5)",
        "pipeline_test_ask_tts": "Nuevo nivel TTS (volumen de voz, ej. 1.0, 3.0)",
        "pipeline_test_remux": "\nVolviendo a muxear con nuevos niveles...",
        "pipeline_test_done": "Remux terminado -> {path}",
        "pipeline_test_continue": "Vuelva a abrir el video para verificar. CTRL+C para salir, de lo contrario continúe.",
        "pipeline_test_deleted": "[PRUEBA] Archivo eliminado: {path}",
        "pipeline_test_del_err": "[PRUEBA] No se puede eliminar el archivo de prueba ({path}): {err}",
        "opt_input_dir": "Carpeta de entrada (input_dir)",
        "opt_output_dir": "Carpeta de salida (output_dir)",
        "opt_tmp_dir": "Carpeta temporal (tmp_dir)",
        "opt_orig_lang": "Idioma original",
        "opt_ducking": "Reducción (ducking) en dB",
        "opt_offset": "Desplazamiento Subtítulos/TTS (ms, negativo = antes)",
        "opt_offset_video": "Desplazamiento de video (ms, negativo = antes)",
        "opt_bg_mix": "Nivel BG (1.0 = sin cambios)",
        "opt_tts_mix": "Nivel TTS (1.0 = sin cambios)",
        "opt_min_rate": "Velocidad mín. TTS (1.0 = sin cambios)",
        "opt_max_rate": "Velocidad máx. TTS (1.8 = sin cambios)",
        "opt_codec": "Códec de audio",
        "opt_bitrate": "Tasa de bits",
        "ui_invalid_value": "Valor no válido, manteniendo el valor predeterminado.",
        "tts_progress": "\rTTS: {pct}% [{done}/{total}]",
        "tts_warn_freeze": "\n[WARN] Sin progreso TTS. Relanzamiento síncrono de segmentos restantes...",
        "sub_mkvtoolnix_required": "Se requiere MKVToolNix para identificar pistas (mkvmerge).",
        "sub_no_tracks": "No hay pistas de subtítulos integradas.",
        "sub_extract_text_success": "SRT extraído (texto) -> {path}",
        "sub_extract_text_failed": "Fallo en la extracción de SRT (texto).",
        "sub_ffmpeg_error": "Error de ffmpeg al extraer subs de texto: {err}",
        "sub_mkvextract_not_found": "mkvextract no encontrado.",
        "sub_ocr_success": "SRT OCR ({method}) -> {path}",
        "sub_no_ocr": "Ningún OCR disponible.",
        "sub_auto_extract_failed": "[AUTO] Fallo al extraer SRT de la pista MKV seleccionada para {video}.",
        "sub_auto_not_found": "[AUTO] SRT no encontrado para {video}.",
    },
    "de": {
        "cli_no_video": "Kein Video erkannt. Dateien in ./input ablegen oder --input verwenden.",
        "cli_batch_start": "[BATCH] {path}",
        "cli_sub_choice": "  -> Untertitel-Auswahl: {choice}",
        "cli_audio_index": "  -> Audio-Index (ffprobe global): {index}",
        "cli_tts_engine": "  -> TTS-Engine: {engine}",
        "cli_voice": "  -> Stimme: {voice}",
        "cli_codec": "  -> Codec: {codec} @ {bitrate} kb/s",
        "cli_mix": "  -> bg_mix={bg_mix}, tts_mix={tts_mix}, ducking_db={ducking_db}",
        "cli_rates": "  -> min_rate_tts={min}, max_rate_tts={max}",
        "cli_offsets": "  -> offset_ms={offset}, offset_video_ms={offset_video}",
        "cli_error": "[FEHLER] {msg}",
        "cli_done": "Fertig.",
        "cli_dirs": "[Verzeichnisse] \nEingabe = {input} \nAusgabe = {output} \nTemp    = {tmp}",
        "cli_no_eligible": "Keine geeignete Datei in {path} gefunden",
        "cli_no_eligible_short": "Keine brauchbare Videodatei gefunden.",
        "cli_help_formats": "Akzeptierte Erweiterungen: .mkv, .mp4 (nicht rekursiv).",
        "cli_help_input": "Legen Sie Videos direkt in den Eingabeordner.",
        "cli_menu_title": "Was möchten Sie tun?",
        "cli_menu_change_input": "1) Eingabeordner ändern",
        "cli_menu_help": "2) Hilfe anzeigen (Formaterinnerung)",
        "cli_menu_rescan": "3) Test erneut ausführen (erneut scannen)",
        "cli_menu_quit": "4) Beenden",
        "cli_input_choice": "Auswahl [3]: ",
        "cli_new_input": "Neuer Eingabeordner: ",
        "cli_input_changed": "Eingabeordner geändert zu: {path}",
        "cli_help_details": "\nHILFE:\n- Legen Sie .mkv / .mp4 Videos in den Eingabeordner.\n- .srt Untertitel sind optional (gleicher Name wie Video).\n- Unterordner werden nicht gescannt (nicht rekursiv).\n- Vermeiden Sie Dateien mit null Byte oder gesperrte Dateien.",
        "cli_press_enter": "\nDrücken Sie die Eingabetaste zum erneuten Scannen...",
        "cli_invalid_choice": "Ungültige Auswahl, erneuter Scan.",
        "cli_no_selection": "Keine Datei ausgewählt.",
        "cli_ask_another": "Möchten Sie ein weiteres Video generieren? (j/n): ",
        "cli_files_list": "\nGeeignete Dateien (input/):",
        "cli_select_files": "Nummern zum Verarbeiten eingeben (Leerzeichen, Enter=alle, q=abbrechen): ",
        "cli_selection_cancelled": "Keine Datei ausgewählt.",
        "cli_invalid_selection": "Ungültige Eingabe. Beispiel: 1 3 5 (im Bereich 1..{max}).",
        "cli_audio_tracks": "\nVerfügbare Audiospuren:",
        "cli_track_info": "    {idx} : ffmpeg index {ff_idx}, Sprache={lang}, Titel={title}",
        "cli_choose_track": "Nummer der zu verwendenden Audiospur (Enter=0, q=abbrechen): ",
        "cli_track_cancelled": "Spurauswahl abgebrochen.",
        "cli_invalid_track": "Ungültige Eingabe. Wählen Sie eine Nummer zwischen 0 und {max} oder q zum Abbrechen.",
        "cli_no_subs": "Keine Untertitelquelle verfügbar.",
        "cli_subs_sources": "\nUntertitelquellen:",
        "cli_choose_sub": "Untertitelquelle wählen (0..{max}) [0]: ",
        "cli_lang_avail": "\nVerfügbare TTS-Sprachen:",
        "cli_choose_lang": "Sprachnummer eingeben [1]: ",
        "cli_variants_avail": "\nVerfügbare Varianten für {lang}:",
        "cli_choose_variant": "Variantennummer eingeben [1]: ",
        "cli_voices_avail": "\nVerfügbare Stimmen:",
        "cli_choose_voice": "Stimmnummer eingeben (oder Enter zum Abbrechen): ",
        "cli_engine_choice": "\nTTS-Engine-Auswahl:",
        "cli_engine_1": "    1) OneCore (lokal)",
        "cli_engine_2": "    2) Edge TTS (Cloud)",
        "cli_engine_3": "    3) gTTS (Cloud, inoffiziell)",
        "cli_choose_engine": "Motornummer eingeben [1]: ",
        "cli_no_sub_chosen": "Keine Untertitelquelle ausgewählt.",
        "cli_no_voice": "[FEHLER] Keine gültige TTS-Stimme verfügbar (auch nicht im OneCore-Fallback).",
        "pipeline_process": "{name}",
        "pipeline_no_srt": "Kann SRT für {name} nicht erhalten.",
        "pipeline_extract_audio": "\nExtrahiere Original-Audio (PCM WAV)...",
        "pipeline_no_subs_usable": "Keine brauchbaren Untertitel.",
        "pipeline_gen_tts": "\nGeneriere TTS (WAV)...",
        "pipeline_ducking": "\nOriginal-Audio während Dialogen absenken...",
        "pipeline_mux": "\nMischen/Kodieren/Finaler Mux...",
        "pipeline_test_header": "\n=== TEST VOR BEREINIGUNG ===",
        "pipeline_test_file": "Generierte Datei: {path}",
        "pipeline_test_check": "Öffnen Sie das Video und überprüfen Sie die Pegel (bg / tts).",
        "pipeline_test_ask": "Möchten Sie die Pegel anpassen und neu muxen? (j/n): ",
        "pipeline_test_ask_bg": "Neuer BG-Pegel (Hintergrundlautstärke, z.B. 1.0, 2.5)",
        "pipeline_test_ask_tts": "Neuer TTS-Pegel (Sprachlautstärke, z.B. 1.0, 3.0)",
        "pipeline_test_remux": "\nNeu muxen mit neuen Pegeln...",
        "pipeline_test_done": "Remux fertig -> {path}",
        "pipeline_test_continue": "Video erneut öffnen zur Überprüfung. STRG+C zum Beenden, sonst fortfahren.",
        "pipeline_test_deleted": "[TEST] Datei gelöscht: {path}",
        "pipeline_test_del_err": "[TEST] Kann Testdatei nicht löschen ({path}): {err}",
        "opt_input_dir": "Eingabeordner (input_dir)",
        "opt_output_dir": "Ausgabeordner (output_dir)",
        "opt_tmp_dir": "Temporärer Ordner (tmp_dir)",
        "opt_orig_lang": "Originalsprache",
        "opt_ducking": "Absenkung (Ducking) in dB",
        "opt_offset": "Untertitel/TTS-Versatz (ms, negativ = früher)",
        "opt_offset_video": "Video-Versatz (ms, negativ = früher)",
        "opt_bg_mix": "BG-Pegel (1.0 = unverändert)",
        "opt_tts_mix": "TTS-Pegel (1.0 = unverändert)",
        "opt_min_rate": "Min. TTS-Geschwindigkeit (1.0 = unverändert)",
        "opt_max_rate": "Max. TTS-Geschwindigkeit (1.8 = unverändert)",
        "opt_codec": "Audio-Codec",
        "opt_bitrate": "Bitrate",
        "ui_invalid_value": "Ungültiger Wert, Standard wird beibehalten.",
        "tts_progress": "\rTTS: {pct}% [{done}/{total}]",
        "tts_warn_freeze": "\n[WARN] Kein TTS-Fortschritt. Synchroner Neustart der verbleibenden Segmente...",
        "sub_mkvtoolnix_required": "MKVToolNix erforderlich, um Spuren zu identifizieren (mkvmerge).",
        "sub_no_tracks": "Keine eingebetteten Untertitelspuren.",
        "sub_extract_text_success": "SRT extrahiert (Text) -> {path}",
        "sub_extract_text_failed": "SRT-Extraktion fehlgeschlagen (Text).",
        "sub_ffmpeg_error": "ffmpeg-Fehler beim Extrahieren von Text-Subs: {err}",
        "sub_mkvextract_not_found": "mkvextract nicht gefunden.",
        "sub_ocr_success": "SRT OCR ({method}) -> {path}",
        "sub_no_ocr": "Kein OCR verfügbar.",
        "sub_auto_extract_failed": "[AUTO] Fehler beim Extrahieren von SRT aus ausgewählter MKV-Spur für {video}.",
        "sub_auto_not_found": "[AUTO] SRT nicht gefunden für {video}.",
    },
    "it": {
        "cli_no_video": "Nessun video rilevato. Inserisci file in ./input o usa --input.",
        "cli_batch_start": "[BATCH] {path}",
        "cli_sub_choice": "  -> scelta sottotitoli: {choice}",
        "cli_audio_index": "  -> indice audio (ffprobe globale): {index}",
        "cli_tts_engine": "  -> motore tts: {engine}",
        "cli_voice": "  -> voce: {voice}",
        "cli_codec": "  -> codec: {codec} @ {bitrate} kb/s",
        "cli_mix": "  -> mix_bg={bg_mix}, mix_tts={tts_mix}, ducking_db={ducking_db}",
        "cli_rates": "  -> tasso_min_tts={min}, tasso_max_tts={max}",
        "cli_offsets": "  -> offset_ms={offset}, offset_video_ms={offset_video}",
        "cli_error": "[ERRORE] {msg}",
        "cli_done": "Fatto.",
        "cli_dirs": "[cartelle] \ninput  = {input} \noutput = {output} \ntmp    = {tmp}",
        "cli_no_eligible": "Nessun file idoneo trovato in {path}",
        "cli_no_eligible_short": "Nessun file video utilizzabile trovato.",
        "cli_help_formats": "Estensioni accettate: .mkv, .mp4 (non ricorsivo).",
        "cli_help_input": "Posiziona i video direttamente nella cartella di input.",
        "cli_menu_title": "Cosa vuoi fare?",
        "cli_menu_change_input": "1) Cambia cartella di input",
        "cli_menu_help": "2) Mostra aiuto (promemoria formati)",
        "cli_menu_rescan": "3) Riesegui test (nuova scansione)",
        "cli_menu_quit": "4) Esci",
        "cli_input_choice": "Scelta [3]: ",
        "cli_new_input": "Nuova cartella di input: ",
        "cli_input_changed": "Cartella di input cambiata in: {path}",
        "cli_help_details": "\nAIUTO:\n- Posiziona video .mkv / .mp4 nella cartella di input.\n- I sottotitoli .srt sono opzionali (stesso nome del video).\n- Le sottocartelle non vengono scansionate (non ricorsivo).\n- Evita file di zero byte o bloccati.",
        "cli_press_enter": "\nPremi Invio per scansionare di nuovo...",
        "cli_invalid_choice": "Scelta non valida, nuova scansione.",
        "cli_no_selection": "Nessun file selezionato.",
        "cli_ask_another": "Vuoi generare un altro video? (s/n): ",
        "cli_files_list": "\nFile idonei (input/):",
        "cli_select_files": "Inserisci i numeri da elaborare (spazi, Invio=tutti, q=annulla): ",
        "cli_selection_cancelled": "Nessun file selezionato.",
        "cli_invalid_selection": "Input non valido. Esempio: 1 3 5 (nell'intervallo 1..{max}).",
        "cli_audio_tracks": "\nTracce audio disponibili:",
        "cli_track_info": "    {idx} : indice ffmpeg {ff_idx}, lingua={lang}, titolo={title}",
        "cli_choose_track": "Numero della traccia audio da usare (Invio=0, q=annulla): ",
        "cli_track_cancelled": "Selezione traccia annullata.",
        "cli_invalid_track": "Input non valido. Scegli un numero tra 0 e {max}, o q per annullare.",
        "cli_no_subs": "Nessuna fonte di sottotitoli disponibile.",
        "cli_subs_sources": "\nFonti sottotitoli:",
        "cli_choose_sub": "Scegli fonte sottotitoli (0..{max}) [0]: ",
        "cli_lang_avail": "\nLingue TTS disponibili:",
        "cli_choose_lang": "Inserisci numero lingua [1]: ",
        "cli_variants_avail": "\nVarianti disponibili per {lang}:",
        "cli_choose_variant": "Inserisci numero variante [1]: ",
        "cli_voices_avail": "\nVoci disponibili:",
        "cli_choose_voice": "Inserisci numero voce (o Invio per annullare): ",
        "cli_engine_choice": "\nScelta motore TTS:",
        "cli_engine_1": "    1) OneCore (locale)",
        "cli_engine_2": "    2) Edge TTS (cloud)",
        "cli_engine_3": "    3) gTTS (cloud, non ufficiale)",
        "cli_choose_engine": "Inserisci numero motore [1]: ",
        "cli_no_sub_chosen": "Nessuna fonte di sottotitoli scelta.",
        "cli_no_voice": "[ERRORE] Nessuna voce TTS valida disponibile (anche in fallback OneCore).",
        "pipeline_process": "{name}",
        "pipeline_no_srt": "Impossibile ottenere SRT per {name}.",
        "pipeline_extract_audio": "\nEstrazione audio originale (PCM WAV)...",
        "pipeline_no_subs_usable": "Nessun sottotitolo utilizzabile.",
        "pipeline_gen_tts": "\nGenerazione TTS (WAV)...",
        "pipeline_ducking": "\nDucking audio originale durante i dialoghi...",
        "pipeline_mux": "\nMixaggio/Codifica/Mux finale...",
        "pipeline_test_header": "\n=== TEST PRIMA DELLA PULIZIA ===",
        "pipeline_test_file": "File generato: {path}",
        "pipeline_test_check": "Apri il video e controlla i livelli (bg / tts).",
        "pipeline_test_ask": "Vuoi regolare i livelli e rifare il mux? (s/n): ",
        "pipeline_test_ask_bg": "Nuovo livello BG (volume sfondo, es. 1.0, 2.5)",
        "pipeline_test_ask_tts": "Nuovo livello TTS (volume voce, es. 1.0, 3.0)",
        "pipeline_test_remux": "\nRe-mux con nuovi livelli...",
        "pipeline_test_done": "Remux completato -> {path}",
        "pipeline_test_continue": "Riapri il video per verificare. CTRL+C per uscire, altrimenti continua.",
        "pipeline_test_deleted": "[TEST] File eliminato: {path}",
        "pipeline_test_del_err": "[TEST] Impossibile eliminare file di test ({path}): {err}",
        "opt_input_dir": "Cartella di input (input_dir)",
        "opt_output_dir": "Cartella di output (output_dir)",
        "opt_tmp_dir": "Cartella temporanea (tmp_dir)",
        "opt_orig_lang": "Lingua originale",
        "opt_ducking": "Riduzione (ducking) in dB",
        "opt_offset": "Offset Sottotitoli/TTS (ms, negativo = prima)",
        "opt_offset_video": "Offset video (ms, negativo = prima)",
        "opt_bg_mix": "Livello BG (1.0 = invariato)",
        "opt_tts_mix": "Livello TTS (1.0 = invariato)",
        "opt_min_rate": "Velocità min TTS (1.0 = invariato)",
        "opt_max_rate": "Velocità max TTS (1.8 = invariato)",
        "opt_codec": "Codec audio",
        "opt_bitrate": "Bitrate",
        "ui_invalid_value": "Valore non valido, mantengo il default.",
        "tts_progress": "\rTTS: {pct}% [{done}/{total}]",
        "tts_warn_freeze": "\n[WARN] Nessun progresso TTS. Rilancio sincrono dei segmenti rimanenti...",
        "sub_mkvtoolnix_required": "MKVToolNix richiesto per identificare le tracce (mkvmerge).",
        "sub_no_tracks": "Nessuna traccia di sottotitoli integrata.",
        "sub_extract_text_success": "SRT estratto (testo) -> {path}",
        "sub_extract_text_failed": "Estrazione SRT fallita (testo).",
        "sub_ffmpeg_error": "Errore ffmpeg estrazione subs testo: {err}",
        "sub_mkvextract_not_found": "mkvextract non trovato.",
        "sub_ocr_success": "SRT OCR ({method}) -> {path}",
        "sub_no_ocr": "Nessun OCR disponibile.",
        "sub_auto_extract_failed": "[AUTO] Estrazione SRT fallita dalla traccia MKV selezionata per {video}.",
        "sub_auto_not_found": "[AUTO] SRT non trovato per {video}.",
    },
    "ja": {
        "cli_no_video": "動画が検出されませんでした。./input にファイルを置くか、--input を使用してください。",
        "cli_batch_start": "[バッチ] {path}",
        "cli_sub_choice": "  -> 字幕選択: {choice}",
        "cli_audio_index": "  -> 音声インデックス (ffprobe global): {index}",
        "cli_tts_engine": "  -> TTSエンジン: {engine}",
        "cli_voice": "  -> 音声: {voice}",
        "cli_codec": "  -> コーデック: {codec} @ {bitrate} kb/s",
        "cli_mix": "  -> bg_mix={bg_mix}, tts_mix={tts_mix}, ducking_db={ducking_db}",
        "cli_rates": "  -> min_rate_tts={min}, max_rate_tts={max}",
        "cli_offsets": "  -> offset_ms={offset}, offset_video_ms={offset_video}",
        "cli_error": "[エラー] {msg}",
        "cli_done": "完了。",
        "cli_dirs": "[ディレクトリ] \n入力 = {input} \n出力 = {output} \n一時 = {tmp}",
        "cli_no_eligible": "{path} に適格なファイルが見つかりません",
        "cli_no_eligible_short": "使用可能な動画ファイルが見つかりません。",
        "cli_help_formats": "対応拡張子: .mkv, .mp4 (再帰なし)。",
        "cli_help_input": "動画を入力フォルダに直接置いてください。",
        "cli_menu_title": "何をしますか？",
        "cli_menu_change_input": "1) 入力フォルダを変更",
        "cli_menu_help": "2) ヘルプを表示 (形式の確認)",
        "cli_menu_rescan": "3) テスト再実行 (再スキャン)",
        "cli_menu_quit": "4) 終了",
        "cli_input_choice": "選択 [3]: ",
        "cli_new_input": "新しい入力フォルダ: ",
        "cli_input_changed": "入力フォルダを変更しました: {path}",
        "cli_help_details": "\nヘルプ:\n- .mkv / .mp4 動画を入力フォルダに置いてください。\n- .srt 字幕は任意です (動画と同じ名前)。\n- サブフォルダはスキャンされません (再帰なし)。\n- サイズが0のファイルやロックされたファイルは避けてください。",
        "cli_press_enter": "\nEnterキーを押して再スキャン...",
        "cli_invalid_choice": "無効な選択です。再スキャンします。",
        "cli_no_selection": "ファイルが選択されていません。",
        "cli_ask_another": "別の動画を生成しますか？ (y/n): ",
        "cli_files_list": "\n適格なファイル (input/):",
        "cli_select_files": "処理する番号を入力してください (スペース区切り, Enter=すべて, q=キャンセル): ",
        "cli_selection_cancelled": "ファイルが選択されていません。",
        "cli_invalid_selection": "無効な入力です。例: 1 3 5 (範囲 1..{max})。",
        "cli_audio_tracks": "\n利用可能な音声トラック:",
        "cli_track_info": "    {idx} : ffmpeg index {ff_idx}, 言語={lang}, タイトル={title}",
        "cli_choose_track": "使用する音声トラック番号 (Enter=0, q=キャンセル): ",
        "cli_track_cancelled": "トラック選択がキャンセルされました。",
        "cli_invalid_track": "無効な入力です。0 から {max} の間の番号を選択するか、q でキャンセルしてください。",
        "cli_no_subs": "利用可能な字幕ソースがありません。",
        "cli_subs_sources": "\n字幕ソース:",
        "cli_choose_sub": "字幕ソースを選択 (0..{max}) [0]: ",
        "cli_lang_avail": "\n利用可能なTTS言語:",
        "cli_choose_lang": "言語番号を入力 [1]: ",
        "cli_variants_avail": "\n{lang} の利用可能なバリエーション:",
        "cli_choose_variant": "バリエーション番号を入力 [1]: ",
        "cli_voices_avail": "\n利用可能な音声:",
        "cli_choose_voice": "音声番号を入力 (または Enter でキャンセル): ",
        "cli_engine_choice": "\nTTSエンジンの選択:",
        "cli_engine_1": "    1) OneCore (ローカル)",
        "cli_engine_2": "    2) Edge TTS (クラウド)",
        "cli_engine_3": "    3) gTTS (クラウド, 非公式)",
        "cli_choose_engine": "エンジン番号を入力 [1]: ",
        "cli_no_sub_chosen": "字幕ソースが選択されていません。",
        "cli_no_voice": "[エラー] 有効なTTS音声が利用できません (OneCoreフォールバックを含む)。",
        "pipeline_process": "{name}",
        "pipeline_no_srt": "{name} のSRTを取得できません。",
        "pipeline_extract_audio": "\n元の音声を抽出中 (PCM WAV)...",
        "pipeline_no_subs_usable": "使用可能な字幕がありません。",
        "pipeline_gen_tts": "\nTTSを生成中 (WAV)...",
        "pipeline_ducking": "\n会話中の元の音声をダッキング中...",
        "pipeline_mux": "\nミキシング/エンコード/最終Mux...",
        "pipeline_test_header": "\n=== クリーンアップ前のテスト ===",
        "pipeline_test_file": "生成されたファイル: {path}",
        "pipeline_test_check": "動画を開いてレベルを確認してください (bg / tts)。",
        "pipeline_test_ask": "レベルを調整して再Muxしますか？ (y/n): ",
        "pipeline_test_ask_bg": "新しいBGレベル (背景音量, 例: 1.0, 2.5)",
        "pipeline_test_ask_tts": "新しいTTSレベル (音声音量, 例: 1.0, 3.0)",
        "pipeline_test_remux": "\n新しいレベルで再Mux中...",
        "pipeline_test_done": "再Mux完了 -> {path}",
        "pipeline_test_continue": "動画を再度開いて確認してください。CTRL+C で終了、それ以外は続行。",
        "pipeline_test_deleted": "[テスト] ファイル削除: {path}",
        "pipeline_test_del_err": "[テスト] テストファイルを削除できません ({path}): {err}",
        "opt_input_dir": "入力フォルダ (input_dir)",
        "opt_output_dir": "出力フォルダ (output_dir)",
        "opt_tmp_dir": "一時フォルダ (tmp_dir)",
        "opt_orig_lang": "元の言語",
        "opt_ducking": "ダッキング (dB)",
        "opt_offset": "字幕/TTSオフセット (ms, 負=早い)",
        "opt_offset_video": "動画オフセット (ms, 負=早い)",
        "opt_bg_mix": "BGレベル (1.0 = 変更なし)",
        "opt_tts_mix": "TTSレベル (1.0 = 変更なし)",
        "opt_min_rate": "最小TTS速度 (1.0 = 変更なし)",
        "opt_max_rate": "最大TTS速度 (1.8 = 変更なし)",
        "opt_codec": "音声コーデック",
        "opt_bitrate": "ビットレート",
        "ui_invalid_value": "無効な値です。デフォルトを保持します。",
        "tts_progress": "\rTTS: {pct}% [{done}/{total}]",
        "tts_warn_freeze": "\n[警告] TTSの進行がありません。残りのセグメントを同期的に再実行します...",
        "sub_mkvtoolnix_required": "トラックを識別するにはMKVToolNixが必要です (mkvmerge)。",
        "sub_no_tracks": "埋め込み字幕トラックがありません。",
        "sub_extract_text_success": "SRT抽出 (テキスト) -> {path}",
        "sub_extract_text_failed": "SRT抽出失敗 (テキスト)。",
        "sub_ffmpeg_error": "テキスト字幕抽出中のffmpegエラー: {err}",
        "sub_mkvextract_not_found": "mkvextractが見つかりません。",
        "sub_ocr_success": "SRT OCR ({method}) -> {path}",
        "sub_no_ocr": "OCRが利用できません。",
        "sub_auto_extract_failed": "[自動] {video} の選択されたMKVトラックからのSRT抽出に失敗しました。",
        "sub_auto_not_found": "[自動] {video} のSRTが見つかりません。",
    }
}

_CURRENT_LANG = "en"

def _detect_system_language() -> str:
    """
    Détecte la langue du système.
    Retourne 'fr', 'en', 'es', 'de', 'it' ou 'en' par défaut.
    """
    try:
        lang_code, _ = locale.getdefaultlocale()
        if lang_code:
            lang = lang_code.split("_")[0].lower()
            if lang in TRANSLATIONS:
                return lang
    except Exception:
        pass
    return "en"

def init_language():
    """
    Initialise la langue courante.
    Priorité: options.conf (LANGUAGE) > Système > 'en'
    """
    global _CURRENT_LANG
    
    # 1. Check options.conf
    try:
        opts = effective_values()
        conf_lang = opts.get("language", "auto").lower()
        
        if conf_lang != "auto" and conf_lang in TRANSLATIONS:
            _CURRENT_LANG = conf_lang
            return
    except Exception:
        pass

    # 2. Check system
    _CURRENT_LANG = _detect_system_language()

def t(key: str, **kwargs: Any) -> str:
    """
    Retourne la traduction pour la clé donnée.
    Si la clé n'existe pas dans la langue courante, fallback sur 'en' puis sur la clé elle-même.
    """
    lang_dict = TRANSLATIONS.get(_CURRENT_LANG, TRANSLATIONS["en"])
    text = lang_dict.get(key)
    
    if text is None:
        # Fallback to English
        text = TRANSLATIONS["en"].get(key, key)
        
    try:
        return text.format(**kwargs)
    except Exception:
        return text
